{% extends 'generic/object.html' %}
{% load render_table from django_tables2 %}

{% block content %}
<div class="row mb-3">
    <div class="col col-md-6">
        <div class="card">
            <h5 class="card-header">License Details</h5>
            <table class="table table-hover attr-table">
                <tr>
                    <th scope="row">Name</th>
                    <td>{{ object.name }}</td>
                </tr>
                <tr>
                    <th scope="row">Vendor</th>
                    <td>{{ object.vendor }}</td>
                </tr>
                <tr>
                    <th scope="row">Tenant</th>
                    <td>{{ object.tenant }}</td>
                </tr>
                <tr>
                    <th scope="row">Assignment Type</th>
                    <td>{{ object.assignment_type.model|title|default:"—" }}</td>
                </tr>
                <tr>
                    <th scope="row">Price</th>
                    <td>{{ object.price }} {{ object.currency }}</td>
                </tr>
                <tr>
                    <th scope="row">External ID</th>
                    <td>{{ object.external_id|default:"—" }}</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="col col-md-6">
        <div class="card">
            <h5 class="card-header">License Utilization</h5>
            <table class="table table-hover attr-table">
                <tr>
                    <th scope="row">Total Licenses</th>
                    <td>{{ object.total_licenses }}</td>
                </tr>
                <tr>
                    <th scope="row">Consumed Licenses</th>
                    <td>{{ object.consumed_licenses }}</td>
                </tr>
                <tr>
                    <th scope="row">Available Licenses</th>
                    <td>
                        <span class="{% if object.available_licenses > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ object.available_licenses }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <th scope="row">Utilization</th>
                    <td>
                        {% if object.total_licenses > 0 %}
                            <span class="badge text-bg-{% if object.utilization_percentage >= 90 %}success{% elif object.utilization_percentage >= 70 %}warning{% else %}danger{% endif %}">
                                {{ object.utilization_percentage|floatformat:1 }}%
                            </span>
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">Created</th>
                    <td>{{ object.created }}</td>
                </tr>
                <tr>
                    <th scope="row">Last Modified</th>
                    <td>{{ object.last_updated }}</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="col col-md-6">
        <div class="card">
            <h5 class="card-header">Recent Instances</h5>
            <div class="card-body">
                {% if object.instances.all %}
                    <div class="list-group list-group-flush">
                        {% for instance in object.instances.all|slice:":5" %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <a href="{% url 'plugins:netbox_licenses:licenseinstance' pk=instance.pk %}" class="text-decoration-none">
                                    {% if instance.assigned_object %}
                                        {{ instance.assigned_object }}
                                    {% else %}
                                        <em>Unassigned Instance #{{ instance.pk }}</em>
                                    {% endif %}
                                </a>
                                {% if instance.end_date %}
                                    <br><small class="text-muted">Expires: {{ instance.end_date }}</small>
                                {% endif %}
                            </div>
                            {% if instance.end_date %}
                                {% with days_until_expiry=instance.end_date|timeuntil %}
                                    {% if "ago" in days_until_expiry %}
                                        <span class="badge text-bg-danger">Expired</span>
                                    {% elif "day" in days_until_expiry and "30" not in days_until_expiry %}
                                        <span class="badge text-bg-warning">Soon</span>
                                    {% else %}
                                        <span class="badge text-bg-success">Active</span>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <span class="badge text-bg-secondary">No End Date</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if object.instances.count > 5 %}
                        <div class="text-center mt-2">
                            <a href="{% url 'plugins:netbox_licenses:licenseinstance_list' %}?license={{ object.pk }}" class="btn btn-sm btn-outline-primary">
                                View All {{ object.instances.count }} Instances
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center text-muted">
                        <i class="mdi mdi-license" style="font-size: 2rem;"></i>
                        <p>No instances created</p>
                        <small>Create your first instance to start tracking usage.</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if object.metadata %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">Metadata</h5>
            <div class="card-body">
                <pre class="text-muted">{{ object.metadata }}</pre>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">Quick Actions</h5>
            <div class="card-body">
                <div class="d-flex gap-2 align-items-center">
                    <a href="{% url 'plugins:netbox_licenses:licenseinstance_add' %}?license={{ object.pk }}" class="btn btn-success">
                        <i class="mdi mdi-plus-thick"></i> Add License Instance
                    </a>
                    {% if object.available_licenses > 0 %}
                        <span class="badge text-bg-success">{{ object.available_licenses }} slot(s) available</span>
                    {% else %}
                        <span class="badge text-bg-danger">No available slots</span>
                    {% endif %}
                </div>
                <small class="text-muted mt-2 d-block">Create a new instance of this license and assign it to a contact, device, or service.</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_tabs %}
<!-- License Instances Table Tab -->
<div class="tab-pane" id="instances">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">License Instances ({{ object.consumed_licenses }})</h5>
      <a href="{% url 'plugins:netbox_licenses:licenseinstance_add' %}?license={{ object.pk }}" class="btn btn-sm btn-primary">
        <i class="mdi mdi-plus-thick"></i> Add Instance
      </a>
    </div>
    <div class="card-body">
      {% if instance_table.rows %}
        <div class="table-responsive">
          {% render_table instance_table 'inc/table.html' %}
        </div>
      {% else %}
        <div class="text-center text-muted py-4">
          <i class="mdi mdi-license" style="font-size: 3rem;"></i>
          <h4>No License Instances</h4>
          <p>This license has no active instances. Create your first instance to start tracking usage.</p>
          <a href="{% url 'plugins:netbox_licenses:licenseinstance_add' %}?license={{ object.pk }}" class="btn btn-primary">
            <i class="mdi mdi-plus-thick"></i> Create First Instance
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock extra_tabs %}
