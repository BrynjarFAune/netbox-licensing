{% extends 'base/layout.html' %}
{% load render_table from django_tables2 %}

{% block title %}License Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>License Dashboard</h1>
    </div>
    <div class="col text-end">
        <a href="{% url 'plugins:netbox_licenses:license_list' %}" class="btn btn-primary">
            <i class="mdi mdi-view-list"></i> View All Licenses
        </a>
    </div>
</div>

<!-- Financial Commitment Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Monthly Commitment</h5>
                <h2 class="text-success">{{ summary.total_monthly_commitment|floatformat:0|default:"0" }}</h2>
                <small class="text-muted">NOK/month</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Yearly Commitment</h5>
                <h2 class="text-info">{{ summary.total_yearly_commitment|floatformat:0|default:"0" }}</h2>
                <small class="text-muted">NOK/year</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Auto-Renewing</h5>
                <h2 class="text-primary">{{ summary.auto_renewing_count|default:"0" }}/{{ summary.unique_licenses|default:"0" }}</h2>
                <small class="text-muted">{{ summary.auto_renewing_monthly|floatformat:0|default:"0" }} NOK/month</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Portfolio Value</h5>
                <h2 class="text-warning">{{ summary.total_value_nok|floatformat:0|default:"0" }}</h2>
                <small class="text-muted">Total license investment (NOK)</small>
            </div>
        </div>
    </div>
</div>

<!-- License Utilization Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Licenses</h5>
                <h2 class="text-primary">{{ summary.total_licenses|default:"0" }}</h2>
                <small class="text-muted">{{ summary.unique_vendors|default:"0" }} vendors</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Consumed</h5>
                <h2 class="text-warning">{{ summary.total_consumed|default:"0" }}</h2>
                <small class="text-muted">{{ summary.total_instances|default:"0" }} instances</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Available</h5>
                <h2 class="text-success">{{ summary.total_available|default:"0" }}</h2>
                <small class="text-muted">slots remaining</small>
            </div>
        </div>
    </div>
</div>

<!-- Additional Statistics Row -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Unique Vendors</h5>
                <h3 class="text-info">{{ summary.unique_vendors|default:"0" }}</h3>
                <small class="text-muted">{{ summary.unique_licenses|default:"0" }} unique licenses</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Instances</h5>
                <h3 class="text-primary">{{ summary.total_instances|default:"0" }}</h3>
                <small class="text-muted">license assignments</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Overall Utilization</h5>
                <h2>
                    <span class="badge text-bg-{% if summary.overall_utilization >= 90 %}success{% elif summary.overall_utilization >= 70 %}warning{% else %}danger{% endif %}">
                        {{ summary.overall_utilization|floatformat:1|default:"0" }}%
                    </span>
                </h2>
                <small class="text-muted">license slots used</small>
            </div>
        </div>
    </div>
</div>

<!-- Simple MRR Tracking -->
<div class="alert alert-info mb-4">
    <div class="row align-items-center">
        <div class="col-md-9">
            <h5><i class="mdi mdi-chart-line"></i> <strong>Monthly Recurring Revenue (MRR) Overview</strong></h5>
            <p class="mb-2 text-muted">Portfolio Value = total license investment. MRR = recurring monthly costs from active subscriptions.</p>
            <div class="row">
                <div class="col-md-4">
                    <p class="mb-1"><strong>Current MRR:</strong> {{ summary.current_mrr|floatformat:0|default:"0" }} NOK/month</p>
                    <small class="text-muted">From auto-renewing licenses currently consumed</small>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong>Potential MRR:</strong> {{ summary.potential_mrr|floatformat:0|default:"0" }} NOK/month</p>
                    <small class="text-muted">If all auto-renewing slots are used</small>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong>Manual Monthly Cost:</strong> {{ summary.manual_monthly_cost|floatformat:0|default:"0" }} NOK/month</p>
                    <small class="text-muted">From licenses requiring manual renewal</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 text-center">
            <h6 class="text-muted">MRR Utilization</h6>
            <h2 class="{% if summary.mrr_utilization >= 90 %}text-success{% elif summary.mrr_utilization >= 70 %}text-warning{% else %}text-danger{% endif %}">
                {{ summary.mrr_utilization|floatformat:1|default:"0" }}%
            </h2>
            <small class="text-muted">of auto-renew capacity</small>
        </div>
    </div>
</div>

<!-- Charts and Tables Row -->
<div class="row">
    <!-- Expiration Status Pie Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">License Expiration Status</h5>
            </div>
            <div class="card-body">
                <canvas id="expirationChart" style="max-height: 400px;"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-3">
                            <span class="badge text-bg-danger">Expired</span>
                            <br><strong>{{ expiration_chart_data.expired }}</strong>
                        </div>
                        <div class="col-3">
                            <span class="badge text-bg-warning">≤30 Days</span>
                            <br><strong>{{ expiration_chart_data.expiring_soon }}</strong>
                        </div>
                        <div class="col-3">
                            <span class="badge text-bg-info">≤90 Days</span>
                            <br><strong>{{ expiration_chart_data.expiring_medium }}</strong>
                        </div>
                        <div class="col-3">
                            <span class="badge text-bg-success">Healthy</span>
                            <br><strong>{{ expiration_chart_data.healthy }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Statistics Table -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Vendor License Summary</h5>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Vendor</th>
                            <th class="text-center">Licenses</th>
                            <th class="text-center">Total</th>
                            <th class="text-center">Available</th>
                            <th class="text-end">Value (NOK)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vendor in vendor_stats %}
                        <tr>
                            <td>
                                <a href="{% url 'plugins:netbox_licenses:license_list' %}?vendor={{ vendor.vendor_id }}" class="text-decoration-none">
                                    <strong>{{ vendor.vendor }}</strong>
                                </a>
                                <br>
                                <small class="text-muted">
                                    <span class="badge text-bg-{% if vendor.utilization_percentage >= 90 %}success{% elif vendor.utilization_percentage >= 70 %}warning{% else %}danger{% endif %}">
                                        {{ vendor.utilization_percentage|floatformat:1 }}% utilized
                                    </span>
                                </small>
                            </td>
                            <td class="text-center">{{ vendor.license_count }}</td>
                            <td class="text-center">{{ vendor.total_licenses }}</td>
                            <td class="text-center">
                                {% if vendor.available_licenses > 0 %}
                                    <span class="text-success">{{ vendor.available_licenses }}</span>
                                {% elif vendor.available_licenses == 0 %}
                                    <span class="text-warning">0</span>
                                {% else %}
                                    <span class="text-danger">{{ vendor.available_licenses }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end">{{ vendor.total_price_nok|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No vendor data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{% url 'plugins:netbox_licenses:license_add' %}" class="btn btn-success">
                    <i class="mdi mdi-plus"></i> Add New License
                </a>
                <a href="{% url 'plugins:netbox_licenses:utilization_report' %}" class="btn btn-info">
                    <i class="mdi mdi-chart-line"></i> Utilization Report
                </a>
                <a href="{% url 'plugins:netbox_licenses:vendor_utilization' %}" class="btn btn-info">
                    <i class="mdi mdi-domain"></i> Vendor Analysis
                </a>
                <a href="{% url 'plugins:netbox_licenses:license_renewals' %}" class="btn btn-warning">
                    <i class="mdi mdi-refresh"></i> Renewal Management
                </a>
                <a href="{% url 'plugins:netbox_licenses:cost_allocation' %}" class="btn btn-secondary">
                    <i class="mdi mdi-currency-usd"></i> Cost Allocation
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Expiration Status Pie Chart
    const ctx = document.getElementById('expirationChart').getContext('2d');
    const expirationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Expired', 'Expiring Soon (≤30d)', 'Expiring (≤90d)', 'Healthy (>90d)'],
            datasets: [{
                data: [
                    {{ expiration_chart_data.expired }},
                    {{ expiration_chart_data.expiring_soon }},
                    {{ expiration_chart_data.expiring_medium }},
                    {{ expiration_chart_data.healthy }}
                ],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',   // Red for expired
                    'rgba(255, 193, 7, 0.8)',   // Yellow for expiring soon
                    'rgba(13, 202, 240, 0.8)',  // Cyan for expiring medium
                    'rgba(25, 135, 84, 0.8)'    // Green for healthy
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(13, 202, 240, 1)',
                    'rgba(25, 135, 84, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(event, activeElements) {
                if (activeElements.length > 0) {
                    const elementIndex = activeElements[0].index;
                    let filterUrl = '';

                    // Map chart segments to filter URLs
                    switch(elementIndex) {
                        case 0: // Expired
                            filterUrl = "{% url 'plugins:netbox_licenses:licenseinstance_list' %}?expiry_status=expired";
                            break;
                        case 1: // Expiring Soon (≤30d)
                            filterUrl = "{% url 'plugins:netbox_licenses:licenseinstance_list' %}?expiry_status=expiring_soon";
                            break;
                        case 2: // Expiring (≤90d)
                            filterUrl = "{% url 'plugins:netbox_licenses:licenseinstance_list' %}?expiry_status=expiring_medium";
                            break;
                        case 3: // Healthy (>90d)
                            filterUrl = "{% url 'plugins:netbox_licenses:licenseinstance_list' %}?expiry_status=healthy";
                            break;
                    }

                    if (filterUrl) {
                        window.location.href = filterUrl;
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%) - Click to view';
                        }
                    }
                }
            },
            interaction: {
                mode: 'point'
            }
        }
    });
});
</script>
{% endblock %}