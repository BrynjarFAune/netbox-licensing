{% extends 'base/layout.html' %}
{% load render_table from django_tables2 %}

{% block title %}License Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>License Dashboard</h1>
    </div>
    <div class="col text-end">
        <a href="{% url 'plugins:netbox_licenses:license_list' %}" class="btn btn-primary">
            <i class="mdi mdi-view-list"></i> View All Licenses
        </a>
    </div>
</div>

<!-- Summary Cards Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Licenses</h5>
                <h2 class="text-primary">{{ summary.total_licenses|default:"0" }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Consumed</h5>
                <h2 class="text-warning">{{ summary.total_consumed|default:"0" }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Available</h5>
                <h2 class="text-success">{{ summary.total_available|default:"0" }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Overall Utilization</h5>
                <h2>
                    <span class="badge text-bg-{% if summary.overall_utilization < 80 %}success{% elif summary.overall_utilization < 100 %}warning{% else %}danger{% endif %}">
                        {{ summary.overall_utilization|floatformat:1 }}%
                    </span>
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- Second Summary Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Value (NOK)</h5>
                <h3 class="text-info">{{ summary.total_value_nok|floatformat:2|default:"0" }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Unique Vendors</h5>
                <h3>{{ summary.unique_vendors|default:"0" }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Unique Licenses</h5>
                <h3>{{ summary.unique_licenses|default:"0" }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Instances</h5>
                <h3>{{ summary.total_instances|default:"0" }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Tables Row -->
<div class="row">
    <!-- Expiration Status Pie Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">License Expiration Status</h5>
            </div>
            <div class="card-body">
                <canvas id="expirationChart" style="max-height: 400px;"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-3">
                            <span class="badge text-bg-danger">Expired</span>
                            <br><strong>{{ expiration_chart_data.expired }}</strong>
                        </div>
                        <div class="col-3">
                            <span class="badge text-bg-warning">≤30 Days</span>
                            <br><strong>{{ expiration_chart_data.expiring_soon }}</strong>
                        </div>
                        <div class="col-3">
                            <span class="badge text-bg-info">≤90 Days</span>
                            <br><strong>{{ expiration_chart_data.expiring_medium }}</strong>
                        </div>
                        <div class="col-3">
                            <span class="badge text-bg-success">Healthy</span>
                            <br><strong>{{ expiration_chart_data.healthy }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Statistics Table -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Vendor License Summary</h5>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Vendor</th>
                            <th class="text-center">Licenses</th>
                            <th class="text-center">Total</th>
                            <th class="text-center">Available</th>
                            <th class="text-end">Value (NOK)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vendor in vendor_stats %}
                        <tr>
                            <td>
                                <strong>{{ vendor.vendor }}</strong>
                                <br>
                                <small class="text-muted">
                                    <span class="badge text-bg-{% if vendor.utilization_percentage < 80 %}success{% elif vendor.utilization_percentage < 100 %}warning{% else %}danger{% endif %}">
                                        {{ vendor.utilization_percentage|floatformat:1 }}% utilized
                                    </span>
                                </small>
                            </td>
                            <td class="text-center">{{ vendor.license_count }}</td>
                            <td class="text-center">{{ vendor.total_licenses }}</td>
                            <td class="text-center">
                                {% if vendor.available_licenses > 0 %}
                                    <span class="text-success">{{ vendor.available_licenses }}</span>
                                {% elif vendor.available_licenses == 0 %}
                                    <span class="text-warning">0</span>
                                {% else %}
                                    <span class="text-danger">{{ vendor.available_licenses }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end">{{ vendor.total_price_nok|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No vendor data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{% url 'plugins:netbox_licenses:license_add' %}" class="btn btn-success">
                    <i class="mdi mdi-plus"></i> Add New License
                </a>
                <a href="{% url 'plugins:netbox_licenses:utilization_report' %}" class="btn btn-info">
                    <i class="mdi mdi-chart-line"></i> Utilization Report
                </a>
                <a href="{% url 'plugins:netbox_licenses:vendor_utilization' %}" class="btn btn-info">
                    <i class="mdi mdi-domain"></i> Vendor Analysis
                </a>
                <a href="{% url 'plugins:netbox_licenses:license_renewals' %}" class="btn btn-warning">
                    <i class="mdi mdi-refresh"></i> Renewal Management
                </a>
                <a href="{% url 'plugins:netbox_licenses:cost_allocation' %}" class="btn btn-secondary">
                    <i class="mdi mdi-currency-usd"></i> Cost Allocation
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Expiration Status Pie Chart
    const ctx = document.getElementById('expirationChart').getContext('2d');
    const expirationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Expired', 'Expiring Soon (≤30d)', 'Expiring (≤90d)', 'Healthy (>90d)'],
            datasets: [{
                data: [
                    {{ expiration_chart_data.expired }},
                    {{ expiration_chart_data.expiring_soon }},
                    {{ expiration_chart_data.expiring_medium }},
                    {{ expiration_chart_data.healthy }}
                ],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',   // Red for expired
                    'rgba(255, 193, 7, 0.8)',   // Yellow for expiring soon
                    'rgba(13, 202, 240, 0.8)',  // Cyan for expiring medium
                    'rgba(25, 135, 84, 0.8)'    // Green for healthy
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(13, 202, 240, 1)',
                    'rgba(25, 135, 84, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}